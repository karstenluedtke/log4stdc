
#include <stddef.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include <errno.h>

#include "barefootc/datetime.h"
#include "log4stdc.h"

static l4sc_logger_ptr_t logger;

void
t1(const char *start, const char *stop, long expected)
{
	long nsecs;
	long tolerance = 2;
	bfc_datetime_t t0, t1;

	bfc_init_datetime_from_isotime(&t0, sizeof(t0), start, strlen(start));
	bfc_init_datetime_from_isotime(&t1, sizeof(t1), stop,  strlen(stop));

	nsecs = bfc_datetime_nsecs_between(&t0, &t1);

	L4SC_DEBUG(logger, "%s: %s to %s: %ld, expected %ld(+-%ld)",
			__FUNCTION__, start, stop, nsecs, expected, tolerance);

	assert ((nsecs >= expected-tolerance) && (nsecs <= expected+tolerance));
}

int
main (int argc, char *argv[])
{
	l4sc_configure_from_xml_file("log4j.xml");
	logger = l4sc_get_logger(BFC_DATETIME_LOGGER);

	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:00.0Z",  0);
	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:01.0Z",  1000000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:02.0Z",  2000000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:59.0Z", -1000000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:58.0Z", -2000000000L);

	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:00.1Z",   100000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:01.1Z",  1100000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:02.1Z",  2100000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:59.1Z",  -900000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:58.1Z", -1900000000L);

	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:00.2Z",   200000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:01.2Z",  1200000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:59.2Z",  -800000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:58.2Z", -1800000000L);

	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:00.7Z",   700000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:01.7Z",  1700000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:59.7Z",  -300000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:58.7Z", -1300000000L);

	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:00.9Z",   900000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T12:00:01.9Z",  1900000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:59.9Z",  -100000000L);
	t1("2014-01-01T12:00:00Z", "2014-01-01T11:59:58.9Z", -1100000000L);

	t1("2014-01-01T11:59:59.8Z", "2014-01-01T12:00:00.7Z",   900000000L);
	t1("2014-01-01T11:59:59.8Z", "2014-01-01T12:00:01.7Z",  1900000000L);
	t1("2014-01-01T11:59:59.8Z", "2014-01-01T11:59:59.7Z",  -100000000L);
	t1("2014-01-01T11:59:59.8Z", "2014-01-01T11:59:58.7Z", -1100000000L);

	t1("2014-01-01T23:59:59.8Z", "2014-01-02T00:00:00.7Z",   900000000L);
	t1("2014-01-01T23:59:59.8Z", "2014-01-02T00:00:01.7Z",  1900000000L);
	t1("2014-01-02T00:00:00.8Z", "2014-01-01T23:59:59.7Z", -1100000000L);
	t1("2014-01-02T00:00:00.8Z", "2014-01-01T23:59:58.7Z", -2100000000L);

	if (sizeof(long) > 4) {
	t1("2014-01-01T11:59:30.8Z", "2014-01-01T12:00:00.7Z", 29900*1000000L);
	t1("2014-01-01T11:59:30.8Z", "2014-01-01T12:00:01.7Z", 30900*1000000L);
	t1("2014-01-01T11:59:30.8Z", "2014-01-01T12:00:02.7Z", 31900*1000000L);
	t1("2014-01-01T11:59:30.8Z", "2014-01-01T11:58:59.7Z",-31100*1000000L);
	}

	return (0);
}
